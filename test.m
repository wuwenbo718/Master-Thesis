clc,clear;

%%

path = './data/G08_FoG_2_trial_1_emg.csv';
M = csvread(path,1,0);
Fs=1e3;
f1 = 50;
f3 = 100;
rp = 0.1;
rs = 30;
wp=2*pi*f1/Fs;
ws=2*pi*f3/Fs;
[n,wn]=cheb1ord(wp/pi,ws/pi,rp,rs);
[bz1,az1]=cheby1(n,rp,wp/pi);
fn=1000;
ap=0.1;
as=60;
wp=50;
ws=200; %输入滤波器条件
wpp=wp/(fn/2);
wss=ws/(fn/2);  %归一化;
[nwn]=buttord(wpp,wss,ap,as); %计算阶数截止频率
[b,a]=butter(n,wn);

Mf = filter(b,a,M(:,4));
%[s,f] = stft(sig);
%stft(sig,1e6,'Window',hamming(100,'periodic'),'OverlapLength',80,'FFTLength',100);
figure();
subplot(2,1,1);
plot(M(:,1),M(:,4));
subplot(2,1,2);
plot(M(:,1),Mf);

%%
figure();
subplot(2,2,1);
plot(M(1:4401,1),M(1:4401,4));
subplot(2,2,2);
plot(M(4402:5122,1),M(4402:5122,4));
subplot(2,2,3);
plot(M(5123:5161,1),M(5123:5161,4));
subplot(2,2,4);
plot(M(5162:7842,1),M(5162:7842,4));

figure();
subplot(2,2,1);
plot(M(1:4401,1),Mf(1:4401));
subplot(2,2,2);
plot(M(4402:5122,1),Mf(4402:5122));
subplot(2,2,3);
plot(M(5123:5161,1),Mf(5123:5161));
subplot(2,2,4);
plot(M(5162:7842,1),Mf(5162:7842));

%%

%subplot(2,2,1);
figure();
cwt(M(1:4401,4),1e3);
%subplot(2,2,2);
figure();
cwt(M(4402:5122,4),1e3);
%subplot(2,2,3);
figure();
cwt(M(5123:5161,4),1e3);
%subplot(2,2,4);
figure();
cwt(M(5162:7842,4),1e3);

%%
figure();
cwt(Mf(1:4401),1e3);
figure();
cwt(Mf(4402:5122),1e3);
figure();
cwt(Mf(5123:5161),1e3);
figure();
cwt(Mf(5162:7842),1e3);
%%
figure();
cwt(M(:,4),1e3)

%%
figure();
[c,l] = wavedec(M(4402:5122,4),3,'db2');
approx = appcoef(c,l,'db2');
[cd1,cd2,cd3] = detcoef(c,l,[1 2 3]);
subplot(4,1,1)
plot(approx)
title('Approximation Coefficients')
subplot(4,1,2)
plot(cd3)
title('Level 3 Detail Coefficients')
subplot(4,1,3)
plot(cd2)
title('Level 2 Detail Coefficients')
subplot(4,1,4)
plot(cd1)
title('Level 1 Detail Coefficients')
figure();
plot(M(4402:5122,1),M(4402:5122,4));

%%
sig.time = M(:,1);
sig.signals.values = M(:,4);
sig.signals.dimensions = 1;

%%

T = length(M(:,4));
len = 1000;
Z_stat = zeros(1,T);
Trend = zeros(1,T);
for i = 0:fix(T/len)
   
    if i == fix(T/len)
        [z_stat,trend] = detrend_method(M(i*len+1:i*len+rem(T,len),4),200);
        Z_stat(i*len+1:i*len+rem(T,len)) = z_stat;
        Trend(i*len+1:i*len+rem(T,len)) = trend;
    else
        [z_stat,trend] = detrend_method(M(i*len+1:(i+1)*len,4),200);
        Z_stat(i*len+1:(i+1)*len) = z_stat;
        Trend(i*len+1:(i+1)*len) = trend;
    end
    
end

%%
ind1 = M(:,2)==2;
figure();
plot(M(ind1,1),Z_stat(ind1));
hold on;
plot(M(ind1,1),Trend(ind1));
hold off;
figure();
plot(M(:,1),M(:,4))

%%

x=[-0.26378804,  0.        , -0.7913641 , -1.3189402 , -0.7913641 , ...
        0.7913641 ,  0.7913641 ,  0.        ,  0.5275761 , -0.26378804, ...
        0.        ,  0.        , -0.26378804,  0.26378804,  0.        , ...
        0.        ,  0.5275761 ,  0.26378804,  0.        ,  1.3189402 , ...
        0.7913641 ,  0.        , -0.26378804, -0.5275761 ,  0.26378804, ...
        1.3189402 , -0.5275761 ,  2.1103044 ,  1.0551522 ,  1.5827281 , ...
        2.1103044 ,  2.1103044 ,  0.26378804, -0.5275761 ,  0.        , ...
        1.3189402 ,  2.1103044 ,  2.1103044 ,  0.26378804,  2.3740923 , ...
        1.0551522 ,  0.        ,  1.5827281 ,  1.3189402 ,  1.8465163 , ...
        1.3189402 ,  2.1103044 ,  0.5275761 ,  0.        ,  0.        , ...
        0.26378804,  0.        ,  0.7913641 ,  1.0551522 ,  1.3189402 , ...
        0.        ,  1.5827281 ,  2.1103044 ,  2.1103044 ,  1.5827281 , ...
        2.3740923 ,  0.        , -1.0551522 ,  0.        , -0.7913641 , ...
        1.5827281 ,  0.26378804,  2.3740923 ,  2.1103044 ,  1.0551522 , ...
        1.0551522 ,  1.5827281 ,  1.8465163 ,  1.5827281 ,  1.0551522 , ...
        0.5275761 ,  1.3189402 ,  0.5275761 ,  0.26378804,  1.3189402 , ...
       -0.5275761 , -0.26378804,  0.5275761 ,  0.7913641 ,  0.        , ...
        2.3740923 ,  2.1103044 ,  1.8465163 ,  0.        ,  1.0551522 , ...
        0.        ,  0.        ,  1.0551522 ,  0.7913641 ,  0.        , ...
        1.0551522 ,  0.5275761 ,  1.8465163 ,  1.0551522 , -0.5275761 , ...
        2.1103044 , -0.7913641 ,  1.3189402 ,  1.8465163 , -0.5275761 , ...
        0.        , -0.26378804,  0.        ,  1.8465163 ,  1.8465163 , ...
        0.7913641 , -0.26378804,  0.        ,  0.5275761 ,  1.0551522 , ...
        0.        ,  0.        ,  1.8465163 ,  0.        , -0.7913641 , ...
        0.7913641 ,  1.0551522 , -0.26378804, -0.26378804,  1.3189402 , ...
        0.7913641 , -1.3189402 , -0.5275761 ,  0.        ,  0.        , ...
        0.        , -0.7913641 , -0.5275761 ,  0.26378804, -0.5275761 , ...
        0.        , -1.3189402 , -1.0551522 , -1.3189402 ,  0.        , ...
       -0.5275761 ,  0.        , -0.26378804, -1.8465163 ,  0.5275761 , ...
        0.        ,  1.3189402 , -0.7913641 , -0.26378804,  1.0551522 , ...
       -0.26378804,  1.5827281 , -0.26378804, -1.0551522 ,  0.26378804, ...
        0.        ,  0.5275761 ,  0.26378804, -0.7913641 , -1.3189402 , ...
       -1.5827281 ,  1.5827281 ,  0.        ,  0.7913641 ,  0.        , ...
       -0.5275761 , -0.7913641 ,  0.        , -0.5275761 , -1.3189402 , ...
       -0.5275761 ,  0.5275761 , -0.26378804, -1.0551522 , -1.3189402 , ...
        0.        , -0.26378804, -1.8465163 ,  0.        ,  0.        , ...
       -0.5275761 ,  0.26378804, -0.5275761 , -0.26378804,  0.26378804, ...
        0.26378804,  0.        , -1.0551522 , -0.26378804, -0.5275761 , ...
       -1.3189402 , -0.5275761 , -1.3189402 ,  0.26378804,  0.        , ...
        0.7913641 ,  0.        , -0.7913641 ,  0.26378804, -0.5275761 , ...
        0.        , -1.0551522 ,  0.        ,  0.        ,  0.5275761 , ...
       -1.5827281 , -0.26378804, -1.3189402 ,  0.7913641 ,  0.7913641 , ...
        0.26378804,  1.0551522 ,  1.8465163 ,  0.26378804, -0.5275761 , ...
        0.        , -0.7913641 ,  0.5275761 , -0.26378804, -0.7913641 , ...
        3.1654563 ,  1.8465163 ,  0.26378804,  1.0551522 ,  1.0551522 , ...
        1.8465163 ,  2.1103044 , -0.5275761 ,  0.7913641 ,  1.8465163 , ...
        0.        ,  0.26378804,  1.8465163 ,  0.7913641 ,  1.3189402 , ...
        0.5275761 ,  0.7913641 ,  0.5275761 , -0.26378804,  0.5275761 , ...
        0.        ,  1.3189402 ,  2.1103044 ,  0.5275761 ,  0.        , ...
        1.0551522 ,  1.5827281 ,  2.1103044 ,  2.1103044 ,  2.6378803 , ...
        2.1103044 ,  1.3189402 ,  2.1103044 ,  1.5827281 ,  1.5827281 , ...
       -0.26378804]

%%
function [z_stat, trend] = detrend_method(data,lambda)
    T = length(data);
    I = speye(T);
    D2 = spdiags(ones(T-2,1)*[1 -2 1],[0:2],T-2,T);
    z_stat=(I-inv(I+lambda^2*(D2'*D2)))*data;
    trend = inv(I+lambda^2*(D2'*D2))*data;
end